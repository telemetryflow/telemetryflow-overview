#!/bin/bash
# ==============================================================================
# TelemetryFlow MCP Server - Pre-commit Hook
# ==============================================================================
# Runs quality checks before allowing a commit
# - Go fmt check
# - Go vet
# - Lint with golangci-lint
# - Unit tests (optional, fast mode)
# ==============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
success() { echo -e "${GREEN}âœ… $1${NC}"; }
warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
error() { echo -e "${RED}âŒ $1${NC}"; }

echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘        TelemetryFlow MCP Server - Pre-commit Checks          â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
STAGED_GO_FILES=$(echo "$STAGED_FILES" | grep '\.go$' | grep -v '_test\.go$' || true)
STAGED_TEST_FILES=$(echo "$STAGED_FILES" | grep '_test\.go$' || true)

if [ -z "$STAGED_FILES" ]; then
    warning "No files staged for commit"
    exit 0
fi

info "Staged files:"
echo "$STAGED_FILES" | while read -r file; do
    echo "  - $file"
done
echo ""

# ==============================================================================
# Check 1: Prevent committing sensitive files
# ==============================================================================
info "Checking for sensitive files..."

SENSITIVE_PATTERNS=".env .env.local .env.production credentials secrets private"
for pattern in $SENSITIVE_PATTERNS; do
    if echo "$STAGED_FILES" | grep -qE "(^|/)$pattern"; then
        error "Sensitive file detected: $pattern"
        error "Remove it from staging: git reset HEAD <file>"
        exit 1
    fi
done

# Check for hardcoded secrets patterns in Go files
if [ -n "$STAGED_GO_FILES" ]; then
    for file in $STAGED_GO_FILES; do
        if [ -f "$file" ]; then
            # Check for potential secrets (simple patterns)
            if grep -qE "(password|secret|apiKey|token)\s*[:=]\s*\"[^\"]+\"" "$file" 2>/dev/null; then
                if ! grep -qE "(os\.Getenv|viper\.|config\.|env\.)" "$file" 2>/dev/null; then
                    warning "Potential hardcoded secret in: $file"
                    warning "Please review before committing"
                fi
            fi
        fi
    done
fi

success "No sensitive files detected"
echo ""

# ==============================================================================
# Check 2: Go fmt
# ==============================================================================
if [ -n "$STAGED_GO_FILES" ]; then
    info "Running go fmt on staged Go files..."

    UNFORMATTED=$(gofmt -l $STAGED_GO_FILES 2>/dev/null || true)

    if [ -n "$UNFORMATTED" ]; then
        error "The following files are not formatted:"
        echo "$UNFORMATTED" | while read -r file; do
            echo "  - $file"
        done
        echo ""
        echo "Run 'go fmt ./...' or 'gofmt -w <file>' to fix"
        exit 1
    fi

    success "Go fmt passed"
    echo ""
else
    info "No Go source files to format"
    echo ""
fi

# ==============================================================================
# Check 3: Go vet
# ==============================================================================
if [ -n "$STAGED_GO_FILES" ]; then
    info "Running go vet..."

    if go vet ./... 2>/dev/null; then
        success "Go vet passed"
    else
        error "Go vet found issues. Please fix them before committing."
        exit 1
    fi
    echo ""
fi

# ==============================================================================
# Check 4: golangci-lint
# ==============================================================================
if [ -n "$STAGED_GO_FILES" ]; then
    if command -v golangci-lint &> /dev/null; then
        info "Running golangci-lint..."

        if golangci-lint run --new-from-rev=HEAD~1 2>/dev/null; then
            success "golangci-lint passed"
        else
            error "golangci-lint found issues. Please fix them before committing."
            echo ""
            echo "Run 'golangci-lint run' to see all issues"
            exit 1
        fi
        echo ""
    else
        warning "golangci-lint not installed, skipping lint check"
        echo "  Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
        echo ""
    fi
fi

# ==============================================================================
# Check 5: Run related tests (fast mode)
# ==============================================================================
# Check for staged test files (both inline _test.go and tests/ directory)
STAGED_TESTS_DIR_FILES=$(echo "$STAGED_FILES" | grep '^tests/' || true)

if [ -n "$STAGED_TEST_FILES" ] || [ -n "$STAGED_TESTS_DIR_FILES" ]; then
    info "Running staged test files..."

    # Get unique package directories from _test.go files
    PACKAGES=""
    if [ -n "$STAGED_TEST_FILES" ]; then
        PACKAGES=$(echo "$STAGED_TEST_FILES" | xargs -n1 dirname | sort -u | sed 's|^|./|')
    fi

    # Add tests from tests/ directory (only if files exist in those directories)
    if [ -n "$STAGED_TESTS_DIR_FILES" ]; then
        for dir in $(echo "$STAGED_TESTS_DIR_FILES" | xargs -n1 dirname | sort -u); do
            if [ -d "$dir" ] && ls "$dir"/*.go >/dev/null 2>&1; then
                if [ -n "$PACKAGES" ]; then
                    PACKAGES="$PACKAGES ./$dir/..."
                else
                    PACKAGES="./$dir/..."
                fi
            fi
        done
    fi

    if [ -n "$PACKAGES" ]; then
        if go test -short -race $PACKAGES 2>/dev/null; then
            success "Tests passed"
        else
            error "Tests failed. Please fix failing tests before committing."
            exit 1
        fi
    else
        info "No test packages to run"
    fi
    echo ""
elif [ -n "$STAGED_GO_FILES" ]; then
    info "Running quick test check for changed packages..."

    # Get unique package directories from changed files
    PACKAGES=$(echo "$STAGED_GO_FILES" | xargs -n1 dirname | sort -u | sed 's|^|./|')

    # Also run unit tests if directory exists and has Go files
    if [ -d "tests/unit" ] && find tests/unit -name "*.go" -type f 2>/dev/null | grep -q .; then
        PACKAGES="$PACKAGES ./tests/unit/..."
    fi

    if go test -short -race $PACKAGES 2>/dev/null; then
        success "Related tests passed"
    else
        warning "Some tests may have failed, but continuing..."
    fi
    echo ""
fi

# ==============================================================================
# Summary
# ==============================================================================
echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘              All pre-commit checks passed! ğŸ‰                â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

exit 0